<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1976d2" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>–£—Ä–æ–∫ 3 ‚Äî –ò–µ—Ä–æ–≥–ª–∏—Ñ–∏–∫–∞</title>
  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      color: #333;
      display: flex; flex-direction: column; gap: 10px; padding: 10px; overflow: hidden;
    }
    .header { display: flex; justify-content: space-between; align-items: center; font-size: 16px; color: #555; }
    #status { font-size: 14px; }
    #progress-container { height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; }
    #progress-bar { height: 100%; width: 0%; background: #4caf50; transition: width .3s ease; }
    #board { flex: 1; display: flex; align-items: center; justify-content: center; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.08); min-height: 0; }
    #char { width: 100%; height: 100%; max-width: 480px; max-height: 480px; }
    .controls { display: flex; gap: 8px; justify-content: center; }
    button.primary { padding: 12px 18px; background: #1976d2; color: #fff; border: 0; border-radius: 12px; font-size: 16px; }
    button.secondary { padding: 10px 16px; background: #90a4ae; color: #fff; border: 0; border-radius: 10px; font-size: 15px; }
    .msg { text-align: center; font-weight: 600; }

    @media (max-width: 480px) {
      #char { width: 100%; height: 100%; max-width: 360px; max-height: 360px; }
      button.primary { width: 90%; max-width: 340px; }
      button.secondary { width: 90%; max-width: 340px; }
    }
    @supports (padding: env(safe-area-inset-bottom)) {
      body { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
  <script type="module" src="../auth.js"></script>
</head>
<body>
  <div class="header">
    <div id="status">‚è≥ –ì–æ—Ç–æ–≤–∏–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã —É—Ä–æ–∫–∞ 3‚Ä¶</div>
    <div id="counter"></div>
  </div>
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="board"><div id="char"></div></div>
  <div class="controls">
    <button class="secondary" id="skip-btn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    <button class="primary" id="next-btn" disabled>–°–ª–µ–¥—É—é—â–∏–π</button>
  </div>
  <div class="msg" id="msg"></div>

  <script>
    const statusEl = document.getElementById('status');
    const counterEl = document.getElementById('counter');
    const progressBar = document.getElementById('progress-bar');
    const board = document.getElementById('char');
    const btnSkip = document.getElementById('skip-btn');
    const btnNext = document.getElementById('next-btn');
    const msgEl = document.getElementById('msg');

    let writer = null;
    const queue = [];
    let currentIndex = 0;

    function setProgress() {
      const total = queue.length || 1;
      const pct = Math.min(100, Math.round((currentIndex / total) * 100));
      progressBar.style.width = pct + '%';
      counterEl.textContent = total ? `${currentIndex}/${total}` : '';
    }

    async function extractCharsFromTheory() {
      const res = await fetch('./theory.html?_=' + Date.now());
      const html = await res.text();
      const div = document.createElement('div');
      div.innerHTML = html;
      
      // –°–æ–±–∏—Ä–∞–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –∏–∑ —Å–ª–æ–≤–∞—Ä—è —É—Ä–æ–∫–∞ 3
      const items = Array.from(div.querySelectorAll('.char-list .char-item > span'));
      const chars = [];
      
      items.forEach(span => {
        // span —Å–æ–¥–µ—Ä–∂–∏—Ç "ËÄå√©r" (–∏–µ—Ä–æ–≥–ª–∏—Ñ + –ø–∏–Ω—å–∏–Ω—å) ‚Äî –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π CJK —Å–∏–º–≤–æ–ª
        const text = span.childNodes[0]?.textContent || span.textContent || '';
        const ch = (text.match(/[\u4e00-\u9fff\uf900-\ufaff]/) || [null])[0];
        if (ch) chars.push(ch);
      });
      
      // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ—Ä—è–¥–∫–∞
      const uniq = [];
      const seen = new Set();
      chars.forEach(c => { 
        if (!seen.has(c)) { 
          seen.add(c); 
          uniq.push(c); 
        } 
      });
      
      return uniq;
    }

    function shuffle(arr) { 
      const a = [...arr]; 
      for (let i = a.length - 1; i > 0; i--) { 
        const j = Math.floor(Math.random() * (i + 1)); 
        [a[i], a[j]] = [a[j], a[i]]; 
      } 
      return a; 
    }

    function mountChar(ch) {
      board.innerHTML = '';
      writer = HanziWriter.create('char', ch, {
        width: Math.min(board.clientWidth, 480),
        height: Math.min(board.clientHeight, 480),
        showCharacter: false,
        showOutline: false,
        showHintAfterMisses: 1,
        highlightOnComplete: true,
        padding: 8,
        strokeAnimationSpeed: 1,
        delayBetweenStrokes: 200
      });

      writer.quiz({
        onComplete: function() {
          msgEl.textContent = '‚úÖ –û—Ç–ª–∏—á–Ω–æ!';
          msgEl.style.color = '#2e7d32';
          btnNext.disabled = false;
        },
        onMistake: function() {
          msgEl.textContent = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑';
          msgEl.style.color = '#c62828';
        }
      });
    }

    function nextChar() {
      if (currentIndex >= queue.length) {
        // –£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω
        statusEl.textContent = 'üéâ –£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!';
        board.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h2>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
            <p>–í—ã –∏–∑—É—á–∏–ª–∏ –≤—Å–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã —É—Ä–æ–∫–∞ 3</p>
            <button onclick="location.reload()" style="padding: 12px 24px; background: #1976d2; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
              –ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ
            </button>
          </div>
        `;
        btnSkip.style.display = 'none';
        btnNext.style.display = 'none';
        return;
      }

      const char = queue[currentIndex];
      statusEl.textContent = `–†–∏—Å—É–π—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ: ${char}`;
      mountChar(char);
      setProgress();
    }

    async function init() {
      try {
        statusEl.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã...';
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –∏–∑ —Ç–µ–æ—Ä–∏–∏
        const chars = await extractCharsFromTheory();
        
        if (chars.length === 0) {
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –≤ —Ç–µ–æ—Ä–∏–∏');
        }

        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã
        queue.push(...shuffle(chars));
        
        statusEl.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${chars.length} –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤`;
        
        // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ
        nextChar();
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤';
        msgEl.textContent = error.message;
        msgEl.style.color = '#c62828';
      }
    }

    btnSkip.addEventListener('click', () => {
      currentIndex++;
      nextChar();
    });

    btnNext.addEventListener('click', () => {
      currentIndex++;
      nextChar();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    init();
  </script>
</body>
</html>