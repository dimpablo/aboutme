<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1976d2" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>–£—Ä–æ–∫ 3 ‚Äî –ü—Ä–∞–∫—Ç–∏–∫–∞</title>
  <style>
    html, body {
      width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #555;
      flex-shrink: 0;
    }
    #progress-container {
      width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;
    }
    #progress-bar { height: 100%; width: 0%; background: #4caf50; transition: width 0.3s ease; }
    #task-container {
      flex: 1;
      width: 100%;
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
      padding: 12px;
      overflow: auto;
      min-height: 0;
      max-height: calc(100vh - 140px);
    }
    .controls { display: flex; justify-content: center; }
    #next-btn {
      padding: 14px 24px;
      font-size: 18px; font-weight: 600; color: #fff; background: #1976d2; border: 0; border-radius: 12px; width: 90%; max-width: 320px; box-shadow: 0 4px 6px rgba(0,0,0,.1);
    }
    #next-btn:disabled { background: #bdbdbd; }

    .prompt { font-size: 18px; font-weight: 600; margin: 4px 0 8px; text-align: center; }
    .oracle { font-size: 22px; font-weight: 700; text-align: center; margin: 6px 0; }
    .pinyin-wrap { margin: 8px 0; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .pinyin-toggle { width: 100%; background: #f5f5f5; border: none; padding: 8px 12px; text-align: left; color: #555; font-size: 14px; }
    .pinyin { padding: 0 12px; max-height: 0; overflow: hidden; transition: max-height .25s ease, padding .25s ease; background: #fafafa; color: #666; font-style: italic; }
    .pinyin.expanded { padding: 8px 12px; max-height: 80px; }

    .options { display: grid; gap: 8px; margin: 10px 0; }
    .option-btn, .option-radio, .option-check {
      padding: 10px 12px; background: #f5f7fb; border: 1px solid #dfe3ea; border-radius: 8px; font-size: 16px; text-align: center; cursor: pointer;
    }
    .option-btn.selected, label.option-radio.selected, label.option-check.selected { background: #e4f1ff; border-color: #1976d2; }

    .blink-success { animation: blinkG 300ms ease-in-out 2; }
    .blink-error { animation: blinkR 300ms ease-in-out 2; }
    @keyframes blinkG { 0%,100% { box-shadow: 0 0 0 0 rgba(76,175,80,0); } 50% { box-shadow: 0 0 0 3px rgba(76,175,80,.6); } }
    @keyframes blinkR { 0%,100% { box-shadow: 0 0 0 0 rgba(244,67,54,0); } 50% { box-shadow: 0 0 0 3px rgba(244,67,54,.6); } }

    .message { margin-top: 10px; text-align: center; font-weight: 600; }
    .success { color: #2e7d32; }
    .error { color: #c62828; }
    .matched { background: #e8f5e9 !important; border-color: #2e7d32 !important; color: #2e7d32; }

    .word-pool, .drop-area {
      min-height: 36px; padding: 6px; display: flex; flex-wrap: wrap; gap: 6px; border: 1px dashed #b0bec5; border-radius: 8px; background: #fbfdff; justify-content: center;
    }
    .word-box { background: #fff; border: 1px solid #cfd8dc; border-radius: 6px; padding: 6px 10px; font-size: 16px; cursor: pointer; }

    .pair { padding: 8px; background: #f9fbff; border: 1px solid #e3eaf3; border-radius: 8px; }
    .pair h4 { margin: 0 0 6px; font-size: 14px; color: #455a64; text-align: center; }
    select { width: 100%; padding: 8px 10px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 15px; background: #fff; }

    .section-title { font-size: 14px; color: #607d8b; text-align: center; margin: 6px 0; }

    @media (max-width: 768px) {
      #task-container { padding: 10px; }
      .oracle { font-size: 21px; word-break: break-word; }
      .option-btn, .option-radio, .option-check { font-size: 16px; padding: 10px; }
      .word-box { font-size: 16px; }
    }
    @supports (padding: env(safe-area-inset-bottom)) {
      body { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
  </style>
  <script type="module" src="../auth.js"></script>
</head>
<body>
  <div class="header">
    <div id="status">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è —É—Ä–æ–∫–∞ 3‚Ä¶</div>
    <div id="counter"></div>
  </div>
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="task-container"></div>
  <div class="controls">
    <button id="next-btn" disabled>–°–ª–µ–¥—É—é—â–∏–π</button>
  </div>

  <script type="module">
    import { PointsAPI } from '../auth.js';

    const statusEl = document.getElementById('status');
    const counterEl = document.getElementById('counter');
    const progressBar = document.getElementById('progress-bar');
    const taskContainer = document.getElementById('task-container');
    const btnNext = document.getElementById('next-btn');

    let tasks = [];
    let currentTaskIndex = 0;
    let currentTask = null;
    let userAnswers = {};

    async function loadTasks() {
      try {
        const response = await fetch('./tasks.json');
        const data = await response.json();
        tasks = data.tasks;
        statusEl.textContent = `–£—Ä–æ–∫ 3: ${data.title}`;
        updateProgress();
        showTask(0);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:', error);
        statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π';
      }
    }

    function updateProgress() {
      const total = tasks.length;
      const current = currentTaskIndex + 1;
      const pct = Math.min(100, Math.round((current / total) * 100));
      progressBar.style.width = pct + '%';
      counterEl.textContent = `${current}/${total}`;
    }

    function showTask(index) {
      if (index >= tasks.length) {
        showResults();
        return;
      }

      currentTaskIndex = index;
      currentTask = tasks[index];
      updateProgress();
      btnNext.disabled = true;

      const taskHtml = generateTaskHtml(currentTask);
      taskContainer.innerHTML = taskHtml;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      initializeTask(currentTask);
    }

    function generateTaskHtml(task) {
      let html = `
        <div class="prompt">${task.prompt}</div>
        <div class="oracle">${task.oracle}</div>
        <div class="pinyin-wrap">
          <button class="pinyin-toggle" onclick="togglePinyin(this)">üìñ –ü–æ–∫–∞–∑–∞—Ç—å –ø–∏–Ω—å–∏–Ω—å</button>
          <div class="pinyin">${task.pinyin}</div>
        </div>
      `;

      switch (task.type) {
        case 'choice_single':
          html += generateChoiceSingleHtml(task);
          break;
        case 'choice_multi':
          html += generateChoiceMultiHtml(task);
          break;
        case 'multi_group_single':
          html += generateMultiGroupSingleHtml(task);
          break;
        case 'arrange_words':
          html += generateArrangeWordsHtml(task);
          break;
        case 'match_pairs':
          html += generateMatchPairsHtml(task);
          break;
        case 'fill_blanks':
          html += generateFillBlanksHtml(task);
          break;
        case 'arrange_chars':
          html += generateArrangeCharsHtml(task);
          break;
      }

      return html;
    }

    function generateChoiceSingleHtml(task) {
      let html = `<div class="section-title">${task.question || '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:'}</div>`;
      html += '<div class="options">';
      task.options.forEach((option, index) => {
        html += `<button class="option-btn" data-index="${index}" onclick="selectSingleOption(this, ${index})">${option.text}</button>`;
      });
      html += '</div>';
      return html;
    }

    function generateChoiceMultiHtml(task) {
      let html = '<div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:</div>';
      html += '<div class="options">';
      task.items.forEach((item, index) => {
        html += `<label class="option-check" onclick="toggleMultiOption(this, ${index})">
          <input type="checkbox" data-index="${index}"> ${item.text}
        </label>`;
      });
      html += '</div>';
      return html;
    }

    function generateMultiGroupSingleHtml(task) {
      let html = '<div class="section-title">–û–ø—Ä–µ–¥–µ–ª–∏ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ñ—É–Ω–∫—Ü–∏—é:</div>';
      task.groups.forEach((group, groupIndex) => {
        html += `
          <div class="pair">
            <h4>${group.oracle} (${group.pinyin})</h4>
            <div class="options">
        `;
        group.options.forEach((option, index) => {
          html += `<button class="option-btn" data-group="${groupIndex}" data-index="${index}" onclick="selectGroupOption(this, ${groupIndex}, ${index})">${option}</button>`;
        });
        html += '</div></div>';
      });
      return html;
    }

    function generateArrangeWordsHtml(task) {
      let html = '<div class="section-title">–°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥:</div>';
      html += '<div class="word-pool">';
      task.pool.forEach((word, index) => {
        html += `<div class="word-box" draggable="true" data-word="${word}">${word}</div>`;
      });
      html += '</div>';
      html += '<div class="drop-area" ondrop="dropWord(event)" ondragover="allowDrop(event)">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å–ª–æ–≤–∞ —Å—é–¥–∞</div>';
      return html;
    }

    function generateMatchPairsHtml(task) {
      let html = '<div class="section-title">–°–æ–µ–¥–∏–Ω–∏—Ç–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:</div>';
      html += '<div class="options">';
      task.pairs.forEach((pair, index) => {
        html += `<div class="pair">
          <h4>${pair.oracle} (${pair.pinyin})</h4>
          <div class="options">
        `;
        pair.options.forEach((option, optionIndex) => {
          html += `<button class="option-btn" data-pair="${index}" data-index="${optionIndex}" onclick="selectPairOption(this, ${index}, ${optionIndex})">${option}</button>`;
        });
        html += '</div></div>';
      });
      html += '</div>';
      return html;
    }

    function generateFillBlanksHtml(task) {
      let html = '<div class="section-title">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫–∏ –≤ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö:</div>';
      html += '<div class="options">';
      task.blanks.forEach((blank, index) => {
        html += `<div class="pair">
          <h4>–ü—Ä–æ–ø—É—Å–∫ ${index + 1}</h4>
          <select data-blank="${index}" onchange="selectBlankOption(this, ${index})">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
        `;
        blank.options.forEach(option => {
          html += `<option value="${option}">${option}</option>`;
        });
        html += '</select></div>';
      });
      html += '</div>';
      return html;
    }

    function generateArrangeCharsHtml(task) {
      let html = `<div class="section-title">${task.instruction}</div>`;
      html += '<div class="word-pool">';
      task.pool.forEach((char, index) => {
        html += `<div class="word-box" draggable="true" data-char="${char}">${char}</div>`;
      });
      html += '</div>';
      html += '<div class="drop-area" ondrop="dropChar(event)" ondragover="allowDrop(event)">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã —Å—é–¥–∞</div>';
      return html;
    }

    function initializeTask(task) {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
      switch (task.type) {
        case 'arrange_words':
        case 'arrange_chars':
          initializeDragAndDrop();
          break;
      }
    }

    function initializeDragAndDrop() {
      const wordBoxes = document.querySelectorAll('.word-box');
      wordBoxes.forEach(box => {
        box.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', box.dataset.word || box.dataset.char);
        });
      });
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
    window.togglePinyin = function(button) {
      const pinyin = button.nextElementSibling;
      pinyin.classList.toggle('expanded');
      button.textContent = pinyin.classList.contains('expanded') ? 'üìñ –°–∫—Ä—ã—Ç—å –ø–∏–Ω—å–∏–Ω—å' : 'üìñ –ü–æ–∫–∞–∑–∞—Ç—å –ø–∏–Ω—å–∏–Ω—å';
    };

    window.selectSingleOption = function(button, index) {
      document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');
      userAnswers[currentTask.id] = index;
      btnNext.disabled = false;
    };

    window.toggleMultiOption = function(label, index) {
      const checkbox = label.querySelector('input');
      checkbox.checked = !checkbox.checked;
      label.classList.toggle('selected', checkbox.checked);
      
      if (!userAnswers[currentTask.id]) userAnswers[currentTask.id] = [];
      if (checkbox.checked) {
        if (!userAnswers[currentTask.id].includes(index)) {
          userAnswers[currentTask.id].push(index);
        }
      } else {
        userAnswers[currentTask.id] = userAnswers[currentTask.id].filter(i => i !== index);
      }
      
      btnNext.disabled = userAnswers[currentTask.id].length === 0;
    };

    window.selectGroupOption = function(button, groupIndex, index) {
      const pair = button.closest('.pair');
      pair.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');
      
      if (!userAnswers[currentTask.id]) userAnswers[currentTask.id] = {};
      userAnswers[currentTask.id][groupIndex] = index;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –≥—Ä—É–ø–ø—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
      const allGroupsFilled = currentTask.groups.every((_, i) => userAnswers[currentTask.id][i] !== undefined);
      btnNext.disabled = !allGroupsFilled;
    };

    window.selectPairOption = function(button, pairIndex, index) {
      const pair = button.closest('.pair');
      pair.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');
      
      if (!userAnswers[currentTask.id]) userAnswers[currentTask.id] = {};
      userAnswers[currentTask.id][pairIndex] = index;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –ø–∞—Ä—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
      const allPairsFilled = currentTask.pairs.every((_, i) => userAnswers[currentTask.id][i] !== undefined);
      btnNext.disabled = !allPairsFilled;
    };

    window.selectBlankOption = function(select, blankIndex) {
      if (!userAnswers[currentTask.id]) userAnswers[currentTask.id] = {};
      userAnswers[currentTask.id][blankIndex] = select.value;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –ø—Ä–æ–ø—É—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
      const allBlanksFilled = currentTask.blanks.every((_, i) => userAnswers[currentTask.id][i]);
      btnNext.disabled = !allBlanksFilled;
    };

    window.allowDrop = function(event) {
      event.preventDefault();
    };

    window.dropWord = function(event) {
      event.preventDefault();
      const word = event.dataTransfer.getData('text/plain');
      const dropArea = event.target.closest('.drop-area');
      
      if (dropArea) {
        const wordBox = document.createElement('div');
        wordBox.className = 'word-box';
        wordBox.textContent = word;
        wordBox.onclick = () => wordBox.remove();
        dropArea.appendChild(wordBox);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å
        checkArrangeWordsAnswer();
      }
    };

    window.dropChar = function(event) {
      event.preventDefault();
      const char = event.dataTransfer.getData('text/plain');
      const dropArea = event.target.closest('.drop-area');
      
      if (dropArea) {
        const charBox = document.createElement('div');
        charBox.className = 'word-box';
        charBox.textContent = char;
        charBox.onclick = () => charBox.remove();
        dropArea.appendChild(charBox);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å
        checkArrangeCharsAnswer();
      }
    };

    function checkArrangeWordsAnswer() {
      const dropArea = document.querySelector('.drop-area');
      const words = Array.from(dropArea.querySelectorAll('.word-box')).map(box => box.textContent);
      
      const isCorrect = currentTask.accepted.some(accepted => 
        accepted.length === words.length && 
        accepted.every(word => words.includes(word))
      );
      
      if (isCorrect) {
        dropArea.style.borderColor = '#4caf50';
        dropArea.style.backgroundColor = '#e8f5e9';
        btnNext.disabled = false;
        userAnswers[currentTask.id] = words;
      }
    }

    function checkArrangeCharsAnswer() {
      const dropArea = document.querySelector('.drop-area');
      const chars = Array.from(dropArea.querySelectorAll('.word-box')).map(box => box.textContent);
      
      const isCorrect = currentTask.expected.length === chars.length && 
        currentTask.expected.every(char => chars.includes(char));
      
      if (isCorrect) {
        dropArea.style.borderColor = '#4caf50';
        dropArea.style.backgroundColor = '#e8f5e9';
        btnNext.disabled = false;
        userAnswers[currentTask.id] = chars;
      }
    }

    function showResults() {
      const correctAnswers = Object.keys(userAnswers).length;
      const totalTasks = tasks.length;
      const percentage = Math.round((correctAnswers / totalTasks) * 100);
      
      taskContainer.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
          <h2>üéâ –£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!</h2>
          <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${correctAnswers} –∏–∑ ${totalTasks}</p>
          <p>–†–µ–∑—É–ª—å—Ç–∞—Ç: ${percentage}%</p>
          <button onclick="location.reload()" style="padding: 12px 24px; background: #1976d2; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
            –ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ
          </button>
        </div>
      `;
      
      btnNext.style.display = 'none';
      
      // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏
      if (window.PointsAPI) {
        const points = Math.round((correctAnswers / totalTasks) * 100);
        window.PointsAPI.inc(points);
      }
    }

    btnNext.addEventListener('click', () => {
      showTask(currentTaskIndex + 1);
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadTasks();
  </script>
</body>
</html>