<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1976d2" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>Урок 1 — Практика</title>
  <style>
    html, body { width: 100%; margin: 0; padding: 0; overflow-x: hidden; }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; color: #333; min-height: 100vh; display: flex; flex-direction: column; padding: 10px; gap: 10px; }
    .header { display: flex; justify-content: space-between; align-items: center; font-size: 16px; color: #555; }
    #progress-container { width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; }
    #progress-bar { height: 100%; width: 0%; background: #4caf50; transition: width 0.3s ease; }
    #task-container { flex: 1; width: 100%; border-radius: 10px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,.08); padding: 12px; overflow: auto; min-height: 0; max-height: calc(100vh - 140px); }
    .controls { display: flex; justify-content: center; }
    #next-btn { padding: 14px 24px; font-size: 18px; font-weight: 600; color: #fff; background: #1976d2; border: 0; border-radius: 12px; width: 90%; max-width: 320px; box-shadow: 0 4px 6px rgba(0,0,0,.1); }
    #next-btn:disabled { background: #bdbdbd; }

    .prompt { font-size: 18px; font-weight: 600; text-align: center; margin: 4px 0 8px; }
    .oracle { font-size: 22px; font-weight: 700; text-align: center; margin: 6px 0; word-break: break-word; }
    .pinyin-wrap { margin: 8px 0; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .pinyin-toggle { width: 100%; background: #f5f5f5; border: none; padding: 8px 12px; text-align: left; color: #555; font-size: 14px; }
    .pinyin { padding: 0 12px; max-height: 0; overflow: hidden; transition: max-height .25s ease, padding .25s ease; background: #fafafa; color: #666; font-style: italic; }
    .pinyin.expanded { padding: 8px 12px; max-height: 80px; }

    .options { display: grid; gap: 8px; margin: 10px 0; }
    .option-btn, .option-radio, .option-check { padding: 10px 12px; background: #f5f7fb; border: 1px solid #dfe3ea; border-radius: 8px; font-size: 16px; text-align: center; cursor: pointer; }
    .option-btn.selected, label.option-radio.selected, label.option-check.selected { background: #e4f1ff; border-color: #1976d2; }

    .pair-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: start; }
    .col { display: flex; flex-direction: column; gap: 8px; }

    .blink-success { animation: blinkG 300ms ease-in-out 2; }
    .blink-error { animation: blinkR 300ms ease-in-out 2; }
    @keyframes blinkG { 0%,100% { box-shadow: 0 0 0 0 rgba(76,175,80,0); } 50% { box-shadow: 0 0 0 3px rgba(76,175,80,.6); } }
    @keyframes blinkR { 0%,100% { box-shadow: 0 0 0 0 rgba(244,67,54,0); } 50% { box-shadow: 0 0 0 3px rgba(244,67,54,.6); } }

    @supports (padding: env(safe-area-inset-bottom)) { body { padding-bottom: calc(10px + env(safe-area-inset-bottom)); } }
  </style>
</head>
<body>
  <div class="header">
    <div id="status">⏳ Загружаем задания урока 1…</div>
    <div id="scale-placeholder"></div>
  </div>
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="task-container"></div>
  <div class="controls"><button id="next-btn" disabled>Следующее задание</button></div>

  <script>
    function shuffle(array) { const arr = [...array]; for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

    const state = { tasks: [], currentIndex: 0 };
    let hanziQueue = [];

    const statusEl = document.getElementById('status');
    const taskContainer = document.getElementById('task-container');
    const nextBtn = document.getElementById('next-btn');
    const progressBar = document.getElementById('progress-bar');

    function updateProgress() { const pct = state.tasks.length ? (state.currentIndex / state.tasks.length) * 100 : 0; progressBar.style.width = pct + '%'; }
    function setMessage(text, ok) { statusEl.textContent = text; statusEl.style.color = ok === true ? '#2e7d32' : ok === false ? '#c62828' : '#555'; }
    function enableNext() { nextBtn.disabled = false; }
    function disableNext() { nextBtn.disabled = true; }

    function el(tag, cls, text) { const n = document.createElement(tag); if (cls) n.className = cls; if (text !== undefined) n.textContent = text; return n; }
    function renderPinyin(text) { const w = el('div', 'pinyin-wrap'); const b = el('button', 'pinyin-toggle', 'Показать пиньинь'); const body = el('div', 'pinyin', text); b.onclick = () => body.classList.toggle('expanded'); w.appendChild(b); w.appendChild(body); return w; }

    // Hanzi scheduler
    async function buildHanziQueue(theoryUrl, targetCount) {
      const res = await fetch(theoryUrl + '?_=' + Date.now()); const html = await res.text(); const tmp = document.createElement('div'); tmp.innerHTML = html;
      const items = Array.from(tmp.querySelectorAll('.char-list .char-item > span'));
      const chars = []; items.forEach(span => { const t = span.childNodes[0]?.textContent || span.textContent || ''; const ch = (t.match(/[\u4e00-\u9fff\uf900-\ufaff]/) || [null])[0]; if (ch) chars.push(ch); });
      const uniq = []; const seen = new Set(); chars.forEach(c => { if (!seen.has(c)) { seen.add(c); uniq.push(c); } });
      if (!uniq.length) return [];
      const picks = []; let pool = shuffle(uniq);
      while (picks.length < targetCount) { if (!pool.length) pool = shuffle(uniq); const ch = pool.pop(); if (!picks.includes(ch)) picks.push(ch); }
      return picks;
    }
    function injectHanziTasks(baseTasks, hanziChars) {
      if (!hanziChars.length) return baseTasks;
      const hanziTasks = hanziChars.map((ch, i) => ({ id: 'hanzi-' + i + '-' + ch, type: 'hanzi_draw', prompt: 'Нарисуйте иероглиф', oracle: ch }));
      const mixed = [...baseTasks]; const step = Math.max(1, Math.floor(mixed.length / (hanziTasks.length + 1))); let idx = step;
      hanziTasks.forEach(ht => { mixed.splice(Math.min(idx, mixed.length), 0, ht); idx += step + 1; });
      return mixed;
    }

    function renderChoiceSingle(task) {
      const w = document.createElement('div');
      if (task.prompt) w.appendChild(el('div', 'prompt', task.prompt));
      if (task.oracle) w.appendChild(el('div', 'oracle', task.oracle));
      if (task.pinyin) w.appendChild(renderPinyin(task.pinyin));
      if (task.question) w.appendChild(el('div', 'prompt', task.question));
      const optionsEl = el('div', 'options'); const options = shuffle(task.options || []); let selected = null;
      options.forEach(opt => { const label = document.createElement('label'); label.className = 'option-radio'; const input = document.createElement('input'); input.type = 'radio'; input.name = 'q'; input.style.display = 'none'; input.onchange = () => { selected = opt; document.querySelectorAll('.option-radio').forEach(n => n.classList.remove('selected')); label.classList.add('selected'); }; label.appendChild(input); label.appendChild(document.createTextNode(opt.text)); optionsEl.appendChild(label); });
      const msg = el('div', 'prompt'); const btn = button('Проверить', () => { if (!selected) { msg.textContent = 'Выберите вариант.'; msg.style.color = '#c62828'; return; } if (!!selected.correct) { msg.textContent = '✅ Верно!'; msg.style.color = '#2e7d32'; enableNext(); } else { msg.textContent = '❌ Неверно.'; msg.style.color = '#c62828'; } });
      w.appendChild(optionsEl); w.appendChild(btn); w.appendChild(msg); return w;
    }

    function renderChoiceMulti(task) {
      const w = document.createElement('div'); if (task.prompt) w.appendChild(el('div', 'prompt', task.prompt));
      const optionsEl = el('div', 'options'); const options = shuffle(task.items || []); const selected = new Map();
      options.forEach(opt => { const label = document.createElement('label'); label.className = 'option-check'; const input = document.createElement('input'); input.type = 'checkbox'; input.style.display = 'none'; input.onchange = () => { selected.set(opt.text, input.checked); label.classList.toggle('selected', input.checked); }; label.appendChild(input); label.appendChild(document.createTextNode(opt.text)); optionsEl.appendChild(label); selected.set(opt.text, false); });
      const msg = el('div', 'prompt'); const btn = button('Проверить', () => { const ok = (task.items || []).every(item => !!selected.get(item.text) === !!item.correct); if (ok) { msg.textContent = '✅ Верно!'; msg.style.color = '#2e7d32'; enableNext(); } else { msg.textContent = '❌ Проверьте выбор.'; msg.style.color = '#c62828'; } });
      w.appendChild(optionsEl); w.appendChild(btn); w.appendChild(msg); return w;
    }

    function renderArrangeWords(task) {
      const w = document.createElement('div'); if (task.prompt) w.appendChild(el('div', 'prompt', task.prompt)); if (task.oracle) w.appendChild(el('div', 'oracle', task.oracle)); if (task.pinyin) w.appendChild(renderPinyin(task.pinyin));
      const pool = el('div', 'word-pool'); const drop = el('div', 'word-pool');
      const addPh = () => { if (!drop.children.length) { const s = document.createElement('span'); s.style.color = '#90a4ae'; s.textContent = '[пусто]'; drop.appendChild(s); } };
      addPh(); shuffle(task.pool || []).forEach(wd => pool.appendChild(token(wd, () => move(pool, drop, wd))));
      const msg = el('div', 'prompt'); const btn = button('Проверить', () => { const cur = Array.from(drop.children).filter(n => n.dataset && n.dataset.t).map(n => n.dataset.t); const ok = (task.accepted || []).some(a => arraysEqual(a, cur)); if (ok) { msg.textContent = '✅ Верно!'; msg.style.color = '#2e7d32'; enableNext(); } else { msg.textContent = '❌ Попробуйте снова.'; msg.style.color = '#c62828'; } });
      const controls = document.createElement('div'); controls.appendChild(btn); controls.appendChild(button('Сбросить', () => renderTask(task)));
      w.appendChild(pool); w.appendChild(drop); w.appendChild(controls); w.appendChild(msg); return w;
    }

    function renderMatchPairs(task) {
      const w = document.createElement('div');
      const grid = el('div', 'pair-grid'); const leftCol = el('div', 'col'); const rightCol = el('div', 'col'); grid.appendChild(leftCol); grid.appendChild(rightCol);
      const pairs = shuffle(task.pairs || []); const leftItems = pairs.map(p => p.left); const rightItems = shuffle(pairs.map(p => p.right));
      let selLeft = null, selRight = null; let matchedCount = 0;
      function mkBtn(text) { const b = el('div', 'option-btn', text); b.tabIndex = 0; return b; }
      leftItems.forEach(txt => { const b = mkBtn(txt); b.addEventListener('click', () => { selLeft = b; highlight(leftCol, b); tryMatch(); }); leftCol.appendChild(b); });
      rightItems.forEach(txt => { const b = mkBtn(txt); b.addEventListener('click', () => { selRight = b; highlight(rightCol, b); tryMatch(); }); rightCol.appendChild(b); });
      function isCorrect(l, r) { return (task.pairs || []).some(p => p.left === l && p.right === r); }
      function tryMatch() {
        if (!selLeft || !selRight) return;
        const l = selLeft.textContent, r = selRight.textContent;
        const ok = isCorrect(l, r);
        const effect = ok ? 'blink-success' : 'blink-error';
        selLeft.classList.add(effect); selRight.classList.add(effect);
        setTimeout(() => { selLeft.classList.remove(effect); selRight.classList.remove(effect); }, 350);
        if (ok) {
          selLeft.classList.add('selected'); selRight.classList.add('selected');
          selLeft.style.pointerEvents = 'none'; selRight.style.pointerEvents = 'none';
          matchedCount++;
          if (matchedCount >= (task.pairs || []).length) { const done = el('div', 'prompt', '✅ Все верно!'); done.style.color = '#2e7d32'; w.appendChild(done); enableNext(); }
        }
        selLeft = null; selRight = null; highlight(leftCol, null); highlight(rightCol, null);
      }
      w.appendChild(grid); return w;
    }

    function renderSelectMapping(task) {
      const w = document.createElement('div'); if (task.prompt) w.appendChild(el('div', 'prompt', task.prompt));
      (task.pairs || []).forEach(p => { const row = document.createElement('div'); row.className = 'task-card'; const title = document.createElement('div'); title.className = 'prompt'; title.textContent = p.char + ' →'; row.appendChild(title); const select = document.createElement('select'); const opts = shuffle(p.options || []); select.innerHTML = '<option value="">— выберите —</option>' + opts.map(o => `<option value="${o}">${o}</option>`).join(''); row.appendChild(select); row.dataset.correct = p.correct; w.appendChild(row); });
      const msg = el('div', 'prompt'); const btn = button('Проверить', () => { const rows = Array.from(w.querySelectorAll('.task-card')); const all = rows.every(r => r.querySelector('select').value); if (!all) { msg.textContent = 'Заполните все.'; msg.style.color = '#c62828'; return; } const ok = rows.every(r => r.querySelector('select').value === r.dataset.correct); if (ok) { msg.textContent = '✅ Все верно!'; msg.style.color = '#2e7d32'; enableNext(); } else { msg.textContent = '❌ Проверьте пары.'; msg.style.color = '#c62828'; } });
      w.appendChild(btn); w.appendChild(msg); return w;
    }

    function renderArrangeChars(task) {
      const w = document.createElement('div'); if (task.prompt) w.appendChild(el('div', 'prompt', task.prompt)); if (task.instruction) w.appendChild(el('div', 'prompt', task.instruction));
      const pool = el('div', 'word-pool'); const drop = el('div', 'word-pool');
      const addPh = () => { if (!drop.children.length) { const s = document.createElement('span'); s.style.color = '#90a4ae'; s.textContent = '[пусто]'; drop.appendChild(s); } };
      addPh(); shuffle(task.pool || []).forEach(ch => pool.appendChild(token(ch, () => move(pool, drop, ch))));
      const msg = el('div', 'prompt'); const btn = button('Проверить', () => { const cur = Array.from(drop.children).filter(n => n.dataset && n.dataset.t).map(n => n.dataset.t); const ok = arraysEqual(cur, task.expected || []); if (ok) { msg.textContent = '✅ Правильно!'; msg.style.color = '#2e7d32'; enableNext(); } else { msg.textContent = '❌ Попробуйте снова.'; msg.style.color = '#c62828'; } });
      const controls = document.createElement('div'); controls.appendChild(btn); controls.appendChild(button('Сбросить', () => renderTask(task)));
      w.appendChild(pool); w.appendChild(drop); w.appendChild(controls); w.appendChild(msg); return w;
    }

    function renderHanziDraw(task) {
      const w = document.createElement('div'); if (task.prompt) w.appendChild(el('div', 'prompt', task.prompt)); const oracle = task.oracle || ''; w.appendChild(el('div', 'oracle', oracle));
      const canvas = document.createElement('div'); canvas.id = 'hanzi-canvas'; canvas.style.width = '100%'; canvas.style.maxWidth = '360px'; canvas.style.height = '360px'; canvas.style.margin = '10px auto'; canvas.style.border = '1px solid #e0e0e0'; canvas.style.borderRadius = '8px'; w.appendChild(canvas);
      const msg = el('div', 'prompt');
      function ensureHanziWriter() { return new Promise((resolve) => { if (window.HanziWriter) return resolve(); const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js'; s.onload = () => resolve(); document.head.appendChild(s); }); }
      ensureHanziWriter().then(() => { const writer = HanziWriter.create('hanzi-canvas', oracle, { width: canvas.clientWidth, height: canvas.clientHeight, showCharacter: false, showOutline: false, showHintAfterMisses: 1, highlightOnComplete: true, padding: 8 }); writer.quiz({ onComplete: function() { msg.textContent = '✅ Готово!'; msg.style.color = '#2e7d32'; enableNext(); } }); });
      w.appendChild(msg); return w;
    }

    function arraysEqual(a,b){ if (a.length!==b.length) return false; for (let i=0;i<a.length;i++) if (a[i]!==b[i]) return false; return true; }
    function button(label, onClick){ const b = document.createElement('button'); b.textContent = label; b.style.margin = '6px'; b.onclick = onClick; return b; }
    function token(t, onClick){ const b = el('div', 'option-btn', t); b.dataset.t = t; b.onclick = onClick; return b; }
    function move(from,to,t){ if (to.firstChild && to.firstChild.tagName==='SPAN') to.removeChild(to.firstChild); const node = Array.from(from.children).find(n => n.dataset && n.dataset.t===t); if (node) from.removeChild(node); const back = token(t, () => { to.removeChild(back); from.appendChild(token(t, () => move(from,to,t))); if (!to.children.length) { const s=document.createElement('span'); s.style.color='#90a4ae'; s.textContent='[пусто]'; to.appendChild(s);} }); to.appendChild(back); }
    function highlight(col, btn){ Array.from(col.children).forEach(n => n.classList.remove('selected')); if (btn) btn.classList.add('selected'); }

    nextBtn.addEventListener('click', () => {
      state.currentIndex++;
      if (state.currentIndex >= state.tasks.length) { taskContainer.innerHTML = '<div class="prompt" style="text-align:center">🎉 Поздравляем! Урок завершён.</div>'; nextBtn.disabled = true; setTimeout(() => { window.location.href = '../'; }, 4000); }
      else { renderTask(state.tasks[state.currentIndex]); }
    });

    function renderTask(task) {
      taskContainer.innerHTML = ''; disableNext(); const title = el('div', 'prompt', `Задание ${state.currentIndex + 1}/${state.tasks.length}`); taskContainer.appendChild(title);
      let content;
      switch(task.type){
        case 'choice_single': content = renderChoiceSingle(task); break;
        case 'choice_multi': content = renderChoiceMulti(task); break;
        case 'arrange_words': content = renderArrangeWords(task); break;
        case 'match_pairs': content = renderMatchPairs(task); break;
        case 'select_mapping': content = renderSelectMapping(task); break;
        case 'arrange_chars': content = renderArrangeChars(task); break;
        case 'hanzi_draw': content = renderHanziDraw(task); break;
        default: content = el('div', null, 'Неизвестный тип задания: ' + task.type);
      }
      taskContainer.appendChild(content); updateProgress();
    }

    function tryFullscreen(){ const el = document.documentElement; const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen; if (req) { try{ req.call(el);}catch(_){} } window.removeEventListener('click', tryFullscreen, {capture:true}); }
    window.addEventListener('click', tryFullscreen, { capture: true, once: true });

    async function init(){
      try{
        if ('serviceWorker' in navigator) { try { await navigator.serviceWorker.register('./sw.js'); } catch(_){} }
        const res = await fetch('./tasks.json?_=' + Date.now()); const data = await res.json();
        const base = shuffle(data.tasks || []);
        const hanziNum = Number(data.number_of_hanzi || 0) | 0;
        hanziQueue = hanziNum > 0 ? await buildHanziQueue('./theory.html', hanziNum) : [];
        state.tasks = hanziQueue.length ? injectHanziTasks(base, hanziQueue) : base;
        setMessage(`✅ Найдено ${state.tasks.length} заданий.`);
        renderTask(state.tasks[0]);
      }catch(e){ setMessage('❌ Не удалось загрузить задания.', false); }
    }
    init();
  </script>
</body>
</html>