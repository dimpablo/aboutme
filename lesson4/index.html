<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1976d2" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>Урок 4 — Практика</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }
    
    #status {
      font-size: 1.2em;
      margin-bottom: 10px;
    }
    
    #counter {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    #progress-container {
      width: 100%;
      height: 20px;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    #progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
    }
    
    #task-container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin: 20px 0;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .task-question {
      font-size: 1.3em;
      margin-bottom: 25px;
      color: #1976d2;
      font-weight: 600;
    }
    
    .task-options {
      display: grid;
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .task-option {
      padding: 15px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }
    
    .task-option:hover {
      border-color: #1976d2;
      background: #e3f2fd;
      transform: translateY(-2px);
    }
    
    .task-option.selected {
      border-color: #1976d2;
      background: #1976d2;
      color: white;
    }
    
    .task-option.correct {
      border-color: #4CAF50;
      background: #4CAF50;
      color: white;
    }
    
    .task-option.incorrect {
      border-color: #f44336;
      background: #f44336;
      color: white;
    }
    
    .controls {
      text-align: center;
      margin-top: 30px;
    }
    
    button {
      padding: 15px 30px;
      font-size: 1.1em;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0 10px;
    }
    
    #next-btn {
      background: #1976d2;
      color: white;
    }
    
    #next-btn:hover:not(:disabled) {
      background: #1565c0;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3);
    }
    
    #next-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .explanation {
      background: #e8f5e8;
      border-left: 4px solid #4CAF50;
      padding: 20px;
      margin: 20px 0;
      border-radius: 0 10px 10px 0;
      display: none;
    }
    
    .explanation.show {
      display: block;
    }
    
    .task-type-specific {
      margin: 20px 0;
    }
    
    .arrange-words {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    
    .word-item {
      padding: 10px 15px;
      background: #e3f2fd;
      border: 2px solid #1976d2;
      border-radius: 8px;
      cursor: move;
      user-select: none;
      transition: all 0.3s ease;
    }
    
    .word-item:hover {
      background: #bbdefb;
      transform: scale(1.05);
    }
    
    .word-item.dragging {
      opacity: 0.5;
      transform: scale(1.1);
    }
    
    .drop-zone {
      min-height: 60px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9f9f9;
      margin: 10px 0;
    }
    
    .drop-zone.drag-over {
      border-color: #1976d2;
      background: #e3f2fd;
    }
    
    .match-pairs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    
    .match-item {
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .match-item:hover {
      border-color: #1976d2;
      background: #e3f2fd;
    }
    
    .match-item.selected {
      border-color: #1976d2;
      background: #1976d2;
      color: white;
    }
    
    .match-item.matched {
      border-color: #4CAF50;
      background: #4CAF50;
      color: white;
    }
    
    .fill-blanks {
      margin: 20px 0;
    }
    
    .blank-input {
      display: inline-block;
      width: 60px;
      height: 40px;
      border: 2px solid #1976d2;
      border-radius: 8px;
      text-align: center;
      font-size: 1.2em;
      margin: 0 5px;
    }
    
    .multi-group {
      margin: 20px 0;
    }
    
    .group {
      margin: 20px 0;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: #f9f9f9;
    }
    
    .group-title {
      font-weight: bold;
      margin-bottom: 15px;
      color: #1976d2;
    }
    
    .group-item {
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .group-item:hover {
      background: #e3f2fd;
      border-color: #1976d2;
    }
    
    .group-item.selected {
      background: #1976d2;
      color: white;
    }
    
    .group-item.correct {
      background: #4CAF50;
      color: white;
    }
    
    .group-item.incorrect {
      background: #f44336;
      color: white;
    }
  </style>
  <script type="module" src="../auth.js"></script>
</head>
<body>
  <div class="header">
    <div id="status">⏳ Загружаем задания урока 4…</div>
    <div id="counter"></div>
  </div>
  
  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>
  
  <div id="task-container">
    <!-- Здесь будут отображаться задания -->
  </div>
  
  <div class="controls">
    <button id="next-btn" disabled>Следующий</button>
  </div>

  <script type="module">
    import { PointsAPI } from '../auth.js';
    
    let currentTaskIndex = 0;
    let tasks = [];
    let userAnswers = {};
    let score = 0;
    
    // Ждем загрузки PointsAPI
    function waitForPointsAPI() {
      if (window.PointsAPI) {
        initApp();
      } else {
        setTimeout(waitForPointsAPI, 100);
      }
    }
    
    function initApp() {
      loadTasks();
      window.PointsAPI.subscribe((user) => {
        if (user) {
          // Пользователь вошел в систему
          console.log('Пользователь вошел:', user.displayName);
        } else {
          // Пользователь вышел из системы
          console.log('Пользователь вышел');
        }
      });
    }
    
    async function loadTasks() {
      try {
        const response = await fetch('./tasks.json');
        const data = await response.json();
        tasks = data.tasks;
        currentTaskIndex = 0;
        updateStatus();
        renderTask();
      } catch (error) {
        console.error('Ошибка загрузки заданий:', error);
        document.getElementById('status').textContent = '❌ Ошибка загрузки заданий';
      }
    }
    
    function updateStatus() {
      const total = tasks.length;
      const current = currentTaskIndex + 1;
      document.getElementById('status').textContent = `Урок 4 — Предлог 自 и конструкция 自...至于`;
      document.getElementById('counter').textContent = `Задание ${current} из ${total}`;
      
      const progress = (current / total) * 100;
      document.getElementById('progress-bar').style.width = progress + '%';
    }
    
    function renderTask() {
      if (currentTaskIndex >= tasks.length) {
        showResults();
        return;
      }
      
      const task = tasks[currentTaskIndex];
      const container = document.getElementById('task-container');
      
      let html = `<div class="task-question">${task.question}</div>`;
      
      switch (task.type) {
        case 'choice_single':
          html += renderChoiceSingle(task);
          break;
        case 'multi_group_single':
          html += renderMultiGroupSingle(task);
          break;
        case 'arrange_words':
          html += renderArrangeWords(task);
          break;
        case 'match_pairs':
          html += renderMatchPairs(task);
          break;
        case 'fill_blanks':
          html += renderFillBlanks(task);
          break;
      }
      
      container.innerHTML = html;
      setupEventListeners(task);
      updateStatus();
    }
    
    function renderChoiceSingle(task) {
      let html = '<div class="task-options">';
      task.options.forEach((option, index) => {
        html += `<div class="task-option" data-index="${index}">${option}</div>`;
      });
      html += '</div>';
      return html;
    }
    
    function renderMultiGroupSingle(task) {
      let html = '<div class="multi-group">';
      task.groups.forEach((group, groupIndex) => {
        html += `<div class="group">
          <div class="group-title">${group.name}</div>`;
        group.items.forEach((item, itemIndex) => {
          html += `<div class="group-item" data-group="${groupIndex}" data-item="${itemIndex}">
            <strong>${item.char}</strong> — ${item.pinyin} — ${item.meaning}
          </div>`;
        });
        html += '</div>';
      });
      html += '</div>';
      return html;
    }
    
    function renderArrangeWords(task) {
      let html = '<div class="arrange-words">';
      task.words.forEach((word, index) => {
        html += `<div class="word-item" draggable="true" data-index="${index}">${word}</div>`;
      });
      html += '</div>';
      html += '<div class="drop-zone" id="drop-zone">Перетащите слова сюда в правильном порядке</div>';
      return html;
    }
    
    function renderMatchPairs(task) {
      let html = '<div class="match-pairs">';
      task.pairs.forEach((pair, index) => {
        html += `<div class="match-item" data-index="${index}" data-side="left">${pair.left}</div>`;
        html += `<div class="match-item" data-index="${index}" data-side="right">${pair.right}</div>`;
      });
      html += '</div>';
      return html;
    }
    
    function renderFillBlanks(task) {
      let html = `<div class="fill-blanks">${task.text}`;
      task.blanks.forEach((blank, index) => {
        html = html.replace('___', `<select class="blank-input" data-blank="${index}">
          <option value="">...</option>
          ${blank.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
        </select>`);
      });
      html += '</div>';
      return html;
    }
    
    function setupEventListeners(task) {
      switch (task.type) {
        case 'choice_single':
          setupChoiceSingle(task);
          break;
        case 'multi_group_single':
          setupMultiGroupSingle(task);
          break;
        case 'arrange_words':
          setupArrangeWords(task);
          break;
        case 'match_pairs':
          setupMatchPairs(task);
          break;
        case 'fill_blanks':
          setupFillBlanks(task);
          break;
      }
      
      document.getElementById('next-btn').addEventListener('click', nextTask);
    }
    
    function setupChoiceSingle(task) {
      const options = document.querySelectorAll('.task-option');
      options.forEach(option => {
        option.addEventListener('click', () => {
          options.forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');
          userAnswers[currentTaskIndex] = parseInt(option.dataset.index);
          document.getElementById('next-btn').disabled = false;
        });
      });
    }
    
    function setupMultiGroupSingle(task) {
      const items = document.querySelectorAll('.group-item');
      items.forEach(item => {
        item.addEventListener('click', () => {
          item.classList.toggle('selected');
          updateMultiGroupAnswer(task);
        });
      });
    }
    
    function updateMultiGroupAnswer(task) {
      const selected = [];
      const items = document.querySelectorAll('.group-item.selected');
      items.forEach(item => {
        const groupIndex = parseInt(item.dataset.group);
        const itemIndex = parseInt(item.dataset.item);
        selected.push(itemIndex);
      });
      userAnswers[currentTaskIndex] = selected;
      document.getElementById('next-btn').disabled = false;
    }
    
    function setupArrangeWords(task) {
      const words = document.querySelectorAll('.word-item');
      const dropZone = document.getElementById('drop-zone');
      
      words.forEach(word => {
        word.addEventListener('dragstart', handleDragStart);
        word.addEventListener('dragend', handleDragEnd);
      });
      
      dropZone.addEventListener('dragover', handleDragOver);
      dropZone.addEventListener('drop', handleDrop);
    }
    
    function handleDragStart(e) {
      e.target.classList.add('dragging');
      e.dataTransfer.setData('text/plain', e.target.dataset.index);
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.target.classList.add('drag-over');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      const dropZone = e.target;
      dropZone.classList.remove('drag-over');
      
      const wordIndex = e.dataTransfer.getData('text/plain');
      const word = document.querySelector(`[data-index="${wordIndex}"]`);
      
      if (dropZone.children.length === 0) {
        dropZone.appendChild(word);
        updateArrangeAnswer();
      }
    }
    
    function updateArrangeAnswer() {
      const dropZone = document.getElementById('drop-zone');
      const words = Array.from(dropZone.children);
      const order = words.map(word => parseInt(word.dataset.index));
      userAnswers[currentTaskIndex] = order;
      document.getElementById('next-btn').disabled = false;
    }
    
    function setupMatchPairs(task) {
      const items = document.querySelectorAll('.match-item');
      let selectedItem = null;
      
      items.forEach(item => {
        item.addEventListener('click', () => {
          if (!selectedItem) {
            selectedItem = item;
            item.classList.add('selected');
          } else {
            if (selectedItem.dataset.index === item.dataset.index && selectedItem !== item) {
              // Правильное сопоставление
              selectedItem.classList.add('matched');
              item.classList.add('matched');
              selectedItem = null;
              updateMatchAnswer(task);
            } else {
              // Неправильное сопоставление
              selectedItem.classList.remove('selected');
              selectedItem = null;
            }
          }
        });
      });
    }
    
    function updateMatchAnswer(task) {
      const matched = document.querySelectorAll('.match-item.matched');
      if (matched.length === task.pairs.length * 2) {
        const answer = [];
        for (let i = 0; i < task.pairs.length; i++) {
          answer.push(i);
        }
        userAnswers[currentTaskIndex] = answer;
        document.getElementById('next-btn').disabled = false;
      }
    }
    
    function setupFillBlanks(task) {
      const selects = document.querySelectorAll('.blank-input');
      selects.forEach(select => {
        select.addEventListener('change', () => {
          updateFillBlanksAnswer(task);
        });
      });
    }
    
    function updateFillBlanksAnswer(task) {
      const selects = document.querySelectorAll('.blank-input');
      const answers = Array.from(selects).map(select => select.value);
      if (answers.every(answer => answer !== '')) {
        userAnswers[currentTaskIndex] = answers;
        document.getElementById('next-btn').disabled = false;
      }
    }
    
    function nextTask() {
      const currentTask = tasks[currentTaskIndex];
      const userAnswer = userAnswers[currentTaskIndex];
      
      if (userAnswer === undefined) {
        alert('Пожалуйста, ответьте на вопрос');
        return;
      }
      
      // Проверяем ответ
      const isCorrect = checkAnswer(currentTask, userAnswer);
      if (isCorrect) {
        score++;
        // Начисляем очки
        if (window.PointsAPI && window.PointsAPI.addPoints) {
          window.PointsAPI.addPoints(10);
        }
      }
      
      // Показываем объяснение
      showExplanation(currentTask, userAnswer, isCorrect);
      
      // Переходим к следующему заданию
      currentTaskIndex++;
      if (currentTaskIndex < tasks.length) {
        setTimeout(() => {
          renderTask();
        }, 3000);
      } else {
        setTimeout(() => {
          showResults();
        }, 3000);
      }
    }
    
    function checkAnswer(task, userAnswer) {
      switch (task.type) {
        case 'choice_single':
          return userAnswer === task.correct;
        case 'multi_group_single':
          return JSON.stringify(userAnswer.sort()) === JSON.stringify(task.correct.sort());
        case 'arrange_words':
          return JSON.stringify(userAnswer) === JSON.stringify(task.correct_order);
        case 'match_pairs':
          return JSON.stringify(userAnswer.sort()) === JSON.stringify(task.correct_matches.sort());
        case 'fill_blanks':
          return userAnswer.every((answer, index) => answer === task.blanks[index].correct);
        default:
          return false;
      }
    }
    
    function showExplanation(task, userAnswer, isCorrect) {
      const container = document.getElementById('task-container');
      const explanationDiv = document.createElement('div');
      explanationDiv.className = `explanation ${isCorrect ? 'correct' : 'incorrect'}`;
      explanationDiv.innerHTML = `
        <h3>${isCorrect ? '✅ Правильно!' : '❌ Неправильно'}</h3>
        <p><strong>Ваш ответ:</strong> ${formatUserAnswer(task, userAnswer)}</p>
        <p><strong>Правильный ответ:</strong> ${formatCorrectAnswer(task)}</p>
        <p><strong>Объяснение:</strong> ${task.explanation}</p>
      `;
      
      container.appendChild(explanationDiv);
      explanationDiv.classList.add('show');
      
      document.getElementById('next-btn').textContent = currentTaskIndex + 1 < tasks.length ? 'Следующий' : 'Завершить';
    }
    
    function formatUserAnswer(task, userAnswer) {
      switch (task.type) {
        case 'choice_single':
          return task.options[userAnswer];
        case 'multi_group_single':
          return 'Выбрано элементов: ' + userAnswer.length;
        case 'arrange_words':
          return userAnswer.map(i => task.words[i]).join(' ');
        case 'match_pairs':
          return 'Сопоставлено пар: ' + userAnswer.length;
        case 'fill_blanks':
          return userAnswer.join(', ');
        default:
          return userAnswer;
      }
    }
    
    function formatCorrectAnswer(task) {
      switch (task.type) {
        case 'choice_single':
          return task.options[task.correct];
        case 'multi_group_single':
          return 'Правильный выбор элементов';
        case 'arrange_words':
          return task.correct_order.map(i => task.words[i]).join(' ');
        case 'match_pairs':
          return 'Все пары сопоставлены правильно';
        case 'fill_blanks':
          return task.blanks.map(b => b.correct).join(', ');
        default:
          return 'Правильный ответ';
      }
    }
    
    function showResults() {
      const container = document.getElementById('task-container');
      const percentage = Math.round((score / tasks.length) * 100);
      
      container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <h2>🎉 Урок завершен!</h2>
          <p>Ваш результат: ${score} из ${tasks.length} (${percentage}%)</p>
          <p>Получено очков: ${score * 10}</p>
          <button onclick="location.reload()" style="margin: 20px; padding: 15px 30px; font-size: 1.1em; background: #4CAF50; color: white; border: none; border-radius: 25px; cursor: pointer;">Пройти урок заново</button>
        </div>
      `;
      
      document.getElementById('next-btn').style.display = 'none';
      document.getElementById('status').textContent = 'Урок завершен';
    }
    
    // Запускаем приложение
    waitForPointsAPI();
  </script>
</body>
</html>